<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Pixel Place Multiplayer</title>
  <style>
    body { 
      margin: 0; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      background: #111; 
      color: white; 
    }
    canvas { 
      border: 2px solid white; 
      image-rendering: pixelated; 
      background: black; 
    }
    .hotbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
    }
    .hotbar div {
      width: 30px; height: 30px; border: 2px solid white; cursor: pointer;
    }
    .hotbar .selected { border: 2px solid yellow; }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div class="hotbar" id="hotbar"></div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    // logical board size
    const BOARD_W = 200, BOARD_H = 200;
    // size of each cell on screen
    const CELL_SIZE = 20;
    // how many tiles fit in viewport
    let VIEW_W = Math.floor(window.innerWidth / CELL_SIZE);
    let VIEW_H = Math.floor(window.innerHeight / CELL_SIZE);

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let socket = new WebSocket("ws://localhost:8000/ws");

    let cursor = { x: 100, y: 100 };
    let board = [];
    for (let y = 0; y < BOARD_H; y++) {
      board[y] = Array(BOARD_W).fill("#000");
    }

    // hotbar colors
    const colors = ["#e00", "#0e0", "#00e", "#ee0", "#0ee", "#e0e", "#fff", "#888", "#000"];
    let selectedColor = colors[0];

    const hotbar = document.getElementById("hotbar");
    colors.forEach((c, i) => {
      let div = document.createElement("div");
      div.style.background = c;
      if (i === 0) div.classList.add("selected");
      div.onclick = () => {
        selectedColor = c;
        document.querySelectorAll(".hotbar div").forEach(d => d.classList.remove("selected"));
        div.classList.add("selected");
      };
      hotbar.appendChild(div);
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "w") cursor.y = Math.max(0, cursor.y - 1);
      if (e.key === "s") cursor.y = Math.min(BOARD_H - 1, cursor.y + 1);
      if (e.key === "a") cursor.x = Math.max(0, cursor.x - 1);
      if (e.key === "d") cursor.x = Math.min(BOARD_W - 1, cursor.x + 1);
      if (e.code === "Space") {
        e.preventDefault(); // stop scrolling
        board[cursor.y][cursor.x] = selectedColor;
        socket.send(JSON.stringify({ x: cursor.x, y: cursor.y, color: selectedColor }));
      }
      if (e.key >= "1" && e.key <= "9") {
        let idx = parseInt(e.key) - 1;
        if (colors[idx]) {
          selectedColor = colors[idx];
          document.querySelectorAll(".hotbar div").forEach(d => d.classList.remove("selected"));
          hotbar.children[idx].classList.add("selected");
        }
      }
    });

    socket.onmessage = (event) => {
      let data = JSON.parse(event.data);
      board[data.y][data.x] = data.color;
    };

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // center viewport around cursor
      let offsetX = cursor.x - Math.floor(VIEW_W / 2);
      let offsetY = cursor.y - Math.floor(VIEW_H / 2);
      if (offsetX < 0) offsetX = 0;
      if (offsetY < 0) offsetY = 0;
      if (offsetX + VIEW_W > BOARD_W) offsetX = BOARD_W - VIEW_W;
      if (offsetY + VIEW_H > BOARD_H) offsetY = BOARD_H - VIEW_H;

      for (let y = 0; y < VIEW_H; y++) {
        for (let x = 0; x < VIEW_W; x++) {
          let bx = x + offsetX, by = y + offsetY;
          ctx.fillStyle = board[by][bx];
          ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
        }
      }

      // draw cursor
      ctx.strokeStyle = "yellow";
      ctx.lineWidth = 2;
      ctx.strokeRect(
        (cursor.x - offsetX) * CELL_SIZE, 
        (cursor.y - offsetY) * CELL_SIZE, 
        CELL_SIZE, CELL_SIZE
      );
    }

    function loop() {
      draw();
      requestAnimationFrame(loop);
    }
    loop();

    window.addEventListener("resize", () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      VIEW_W = Math.floor(window.innerWidth / CELL_SIZE);
      VIEW_H = Math.floor(window.innerHeight / CELL_SIZE);
    });
  </script>
</body>
</html>
