<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Pixel Place Multiplayer</title>
  <style>
    body { 
      margin: 0; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      background: #111; 
      color: white; 
    }
    canvas { 
      border: 2px solid white; 
      image-rendering: pixelated; 
      background: black; 
    }
    .hotbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
    }
    .hotbar div {
      width: 30px; height: 30px; border: 2px solid white; cursor: pointer;
    }
    .hotbar .selected { border: 2px solid yellow; }
    .coordinates {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div class="hotbar" id="hotbar"></div>
  <div class="coordinates" id="coordinates">X: 100, Y: 100</div>

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.2.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJ6-c8Pe7ixoVOSDt43vCIWHDcO2adsGY",
      authDomain: "astro-places-v2.firebaseapp.com",
      databaseURL: "https://astro-places-v2-default-rtdb.firebaseio.com",
      projectId: "astro-places-v2",
      storageBucket: "astro-places-v2.firebasestorage.app",
      messagingSenderId: "923457528346",
      appId: "1:923457528346:web:57acc74de094f19d6467a3"
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    console.log('Firebase initialized');

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const BOARD_W = 200, BOARD_H = 200;
    const CELL_SIZE = 20;
    let VIEW_W = Math.floor(window.innerWidth / CELL_SIZE);
    let VIEW_H = Math.floor(window.innerHeight / CELL_SIZE);

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let cursor = { x: 100, y: 100 };
    let board = [];
    let zoomedOut = false;
    for (let y = 0; y < BOARD_H; y++) {
      board[y] = Array(BOARD_W).fill("#000");
    }

    console.log('Board initialized');

    // Load existing pixels from Firebase
    console.log('Setting up Firebase listener...');
    const pixelsRef = ref(database, 'pixels');
    onValue(pixelsRef, (snapshot) => {
      console.log('Firebase listener triggered!');
      const data = snapshot.val();
      console.log('Firebase data:', data);
      if (data) {
        let loadedCount = 0;
        for (let x in data) {
          for (let y in data[x]) {
            if (data[x][y] && data[x][y].color) {
              const xPos = parseInt(x);
              const yPos = parseInt(y);
              console.log(`Loading pixel at ${xPos},${yPos} with color ${data[x][y].color}`);
              if (xPos >= 0 && xPos < BOARD_W && yPos >= 0 && yPos < BOARD_H) {
                board[yPos][xPos] = data[x][y].color;
                loadedCount++;
              }
            }
          }
        }
        console.log(`Loaded ${loadedCount} pixels from Firebase`);
      } else {
        console.log('No data found in Firebase');
      }
    }, (error) => {
      console.error('Firebase error:', error);
    });

    // colors
    const colors = [
      "#e00", "#0e0", "#00e", "#ee0", "#0ee", "#e0e", "#fff", "#888", "#000",
      "#f80", "#8f0", "#08f", "#f08", "#80f", "#0f8", "#ff8", "#8ff", "#f8f",
      "#840", "#048"
    ];
    let selectedColor = colors[0];

    const hotbar = document.getElementById("hotbar");
    const coordinatesDiv = document.getElementById("coordinates");
    
    // cordinates
    function updateCoordinates() {
      coordinatesDiv.textContent = `X: ${cursor.x}, Y: ${cursor.y}`;
    }
    
    colors.forEach((c, i) => {
      let div = document.createElement("div");
      div.style.background = c;
      if (i === 0) div.classList.add("selected");
      div.onclick = () => {
        selectedColor = c;
        document.querySelectorAll(".hotbar div").forEach(d => d.classList.remove("selected"));
        div.classList.add("selected");
      };
      hotbar.appendChild(div);
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "w") {
        cursor.y = Math.max(0, cursor.y - 1);
        updateCoordinates();
      }
      if (e.key === "s") {
        cursor.y = Math.min(BOARD_H - 1, cursor.y + 1);
        updateCoordinates();
      }
      if (e.key === "a") {
        cursor.x = Math.max(0, cursor.x - 1);
        updateCoordinates();
      }
      if (e.key === "d") {
        cursor.x = Math.min(BOARD_W - 1, cursor.x + 1);
        updateCoordinates();
      }
      if (e.key === "t" || e.key === "T") {
        zoomedOut = !zoomedOut;
      }
      if (e.code === "Space") {
        e.preventDefault(); 
        board[cursor.y][cursor.x] = selectedColor;
        // save
        console.log(`Saving pixel at ${cursor.x},${cursor.y} with color ${selectedColor}`);
        const pixelRef = ref(database, `pixels/${cursor.x}/${cursor.y}`);
        set(pixelRef, { color: selectedColor })
          .then(() => {
            console.log('Pixel saved successfully to Firebase');
          })
          .catch((error) => {
            console.error('Error saving pixel:', error);
          });
      }
      if (e.key >= "1" && e.key <= "9") {
        let idx = parseInt(e.key) - 1;
        if (colors[idx]) {
          selectedColor = colors[idx];
          document.querySelectorAll(".hotbar div").forEach(d => d.classList.remove("selected"));
          hotbar.children[idx].classList.add("selected");
        }
      }
    });

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (zoomedOut) {
        // zoomed out view - show entire board
        const scale = Math.min(canvas.width / BOARD_W, canvas.height / BOARD_H);
        const offsetX = (canvas.width - BOARD_W * scale) / 2;
        const offsetY = (canvas.height - BOARD_H * scale) / 2;
        
        for (let y = 0; y < BOARD_H; y++) {
          for (let x = 0; x < BOARD_W; x++) {
            ctx.fillStyle = board[y][x];
            ctx.fillRect(offsetX + x * scale, offsetY + y * scale, scale, scale);
          }
        }
        
        // draw cursor
        ctx.strokeStyle = "yellow";
        ctx.lineWidth = 2;
        ctx.strokeRect(
          offsetX + cursor.x * scale, 
          offsetY + cursor.y * scale, 
          scale, scale
        );
      } else {
        // normal view
        let offsetX = cursor.x - Math.floor(VIEW_W / 2);
        let offsetY = cursor.y - Math.floor(VIEW_H / 2);
        if (offsetX < 0) offsetX = 0;
        if (offsetY < 0) offsetY = 0;
        if (offsetX + VIEW_W > BOARD_W) offsetX = BOARD_W - VIEW_W;
        if (offsetY + VIEW_H > BOARD_H) offsetY = BOARD_H - VIEW_H;

        for (let y = 0; y < VIEW_H; y++) {
          for (let x = 0; x < VIEW_W; x++) {
            let bx = x + offsetX, by = y + offsetY;
            ctx.fillStyle = board[by][bx];
            ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
          }
        }

        // draw cursor
        ctx.strokeStyle = "yellow";
        ctx.lineWidth = 2;
        ctx.strokeRect(
          (cursor.x - offsetX) * CELL_SIZE, 
          (cursor.y - offsetY) * CELL_SIZE, 
          CELL_SIZE, CELL_SIZE
        );
      }
    }

    function loop() {
      draw();
      requestAnimationFrame(loop);
    }
    loop();

    window.addEventListener("resize", () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      VIEW_W = Math.floor(window.innerWidth / CELL_SIZE);
      VIEW_H = Math.floor(window.innerHeight / CELL_SIZE);
    });
  </script>
</body>
</html>
