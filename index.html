<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>r/Places Canvas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
    }
    .canvas-container {
      margin-top: 20px;
      display: grid;
      gap: 1px;
      background-color: #ccc;
      padding: 10px;
      border: 2px solid #333;
      position: relative;
    }
    .pixel {
      width: 10px;
      height: 10px;
      background-color: white;
      border: 1px solid transparent;
      cursor: pointer;
      transition: box-shadow 0.2s;
      position: relative;
    }
    .pixel:hover {
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }
    .color-palette {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    .color {
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      cursor: pointer;
    }
    .color.selected {
      outline: 2px solid black;
    }
    #creatorBox {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      z-index: 10;
    }
    /* Mod Dashboard */
    #modDashboard {
      display: none;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      width: 80%;
      max-width: 500px;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
    }
    #modDashboard input {
      padding: 10px;
      margin-bottom: 10px;
    }
    #modDashboard button {
      padding: 10px;
      background-color: red;
      color: white;
      border: none;
      cursor: pointer;
    }
    #modDashboard button:hover {
      background-color: darkred;
    }
  </style>
</head>
<body>

  <div class="canvas-container" id="canvas"></div>

  <div class="color-palette" id="palette">
    <div class="color" style="background-color: red;" data-color="red"></div>
    <div class="color" style="background-color: blue;" data-color="blue"></div>
    <div class="color" style="background-color: green;" data-color="green"></div>
    <div class="color" style="background-color: yellow;" data-color="yellow"></div>
    <div class="color" style="background-color: black;" data-color="black"></div>
    <div class="color" style="background-color: white; border-color: #ccc;" data-color="white"></div>
  </div>

  <div id="creatorBox">Placed by: loading...</div>

  <!-- Mod Dashboard -->
  <div id="modDashboard">
    <h2>Mod Dashboard</h2>
    <input type="text" id="modCode" placeholder="Enter code to access mod tools">
    <button id="accessModButton">Access Mod Dashboard</button>
    <div id="modTools" style="display: none;">
      <h3>Ban a User</h3>
      <input type="text" id="banUserId" placeholder="Enter User ID">
      <button id="banButton">Ban User</button>
      <h3>Clear Pixel</h3>
      <input type="number" id="clearPixelId" placeholder="Enter Pixel ID">
      <button id="clearPixelButton">Clear Pixel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // Firebase configuration and initialization
    const firebaseConfig = {
      apiKey: "AIzaSyCpOUr78CAyGatrQdVOw6yf8EK4OvtoMoo",
      authDomain: "astro-places-1aec2.firebaseapp.com",
      projectId: "astro-places-1aec2",
      storageBucket: "astro-places-1aec2.appspot.com",
      messagingSenderId: "502500788903",
      appId: "1:502500788903:web:5f742fd1ad5cce9063e982",
      measurementId: "G-6J7SM1KM05"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Variables
    const canvas = document.getElementById('canvas');
    const palette = document.getElementById('palette');
    const modCodeInput = document.getElementById('modCode');
    const accessModButton = document.getElementById('accessModButton');
    const modDashboard = document.getElementById('modDashboard');
    const modTools = document.getElementById('modTools');
    const banUserIdInput = document.getElementById('banUserId');
    const banButton = document.getElementById('banButton');
    const clearPixelIdInput = document.getElementById('clearPixelId');
    const clearPixelButton = document.getElementById('clearPixelButton');
    let selectedColor = 'red';
    let userId = Math.random().toString(36).substring(2, 9); // Random user ID for this session

    // Check if the entered code is correct to access mod tools
    accessModButton.addEventListener('click', () => {
      if (modCodeInput.value === '608') {
        modDashboard.style.display = 'block';  // Show the mod dashboard
        modCodeInput.style.display = 'none';  // Hide the code input field
        accessModButton.style.display = 'none';
      } else {
        alert('Invalid code');
      }
    });

    // Ban a user
    banButton.addEventListener('click', () => {
      const bannedUserId = banUserIdInput.value;
      if (bannedUserId) {
        const bannedRef = ref(database, `banned/${bannedUserId}`);
        set(bannedRef, true);
        alert(`User ${bannedUserId} is banned.`);
      }
    });

    // Clear a pixel
    clearPixelButton.addEventListener('click', () => {
      const pixelId = clearPixelIdInput.value;
      if (pixelId) {
        const pixelRef = ref(database, `pixels/${pixelId}`);
        set(pixelRef, 'white');
        alert(`Pixel ${pixelId} cleared.`);
      }
    });

    // Function to check if the user is banned
    function checkIfUserBanned() {
      const bannedRef = ref(database, `banned/${userId}`);
      get(bannedRef).then((snapshot) => {
        if (snapshot.exists()) {
          alert("You are banned from editing the canvas.");
          disableCanvas();
        }
      });
    }

    // Disable the canvas if the user is banned
    function disableCanvas() {
      const pixels = document.querySelectorAll('.pixel');
      pixels.forEach(pixel => pixel.style.pointerEvents = 'none');
    }

    // Listen for canvas size changes
    const canvasSizeRef = ref(database, 'canvas/size');
    onValue(canvasSizeRef, (snapshot) => {
      const size = snapshot.val();
      if (size) {
        setCanvasSize(size.width, size.height);
      }
    });

    // Set the canvas size based on the database
    function setCanvasSize(width, height) {
      canvas.innerHTML = '';  // Clear current pixels

      // Dynamically adjust grid-template-columns and rows based on the size
      canvas.style.gridTemplateColumns = `repeat(${width}, 10px)`;
      canvas.style.gridTemplateRows = `repeat(${height}, 10px)`;

      // Recreate the pixels for the new canvas size
      for (let i = 0; i < width * height; i++) {
        const pixel = document.createElement('div');
        pixel.classList.add('pixel');
        pixel.dataset.index = i;

        const pixelRef = ref(database, `pixels/${i}`);
        onValue(pixelRef, (snapshot) => {
          const color = snapshot.val();
          pixel.style.backgroundColor = color || 'white';
        });

        pixel.addEventListener('click', () => {
          if (userId) {
            set(pixelRef, selectedColor);
          }
        });

        // Hover event to display creator's user ID
        pixel.addEventListener('mouseenter', () => {
          const creatorIdRef = ref(database, `pixels/${i}/creator`);
          get(creatorIdRef).then((snapshot) => {
            const creatorId = snapshot.val();
            const creatorBox = document.getElementById('creatorBox');
            if (creatorId) {
              creatorBox.textContent = `Placed by: ${creatorId}`;
              creatorBox.style.display = 'block';
            } else {
              creatorBox.style.display = 'none';
            }
          });
        });

        pixel.addEventListener('mouseleave', () => {
          const creatorBox = document.getElementById('creatorBox');
          creatorBox.style.display = 'none';
        });

        canvas.appendChild(pixel);
      }
    }

    // Set initial canvas size if not defined
    setCanvasSize(50, 50);  // Default size, will be updated by Firebase

    // Add event listeners to the palette
    palette.addEventListener('click', (event) => {
      if (event.target.classList.contains('color')) {
        document.querySelectorAll('.color').forEach(color => color.classList.remove('selected'));
        event.target.classList.add('selected');
        selectedColor = event.target.getAttribute('data-color');
      }
    });

    // Check if the user is banned when the page loads
    checkIfUserBanned();
  </script>
</body>
</html>
