<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro Places</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff4500;
            --primary-hover: #ff5722;
            --background: #1a1a1b;
            --surface: #272729;
            --surface-dark: #1e1e1f;
            --surface-light: #343536;
            --text-primary: #d7dadc;
            --text-secondary: #818384;
            --border: #343536;
            --success: #4caf50;
            --error: #f44336;
            --warning: #ff9800;
            --info: #2196f3;
            --grid-color: #2c2c2c;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            background-color: var(--background);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            line-height: 1.5;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--surface-light) var(--background);
        }

        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: var(--background);
        }

        .main-content::-webkit-scrollbar-thumb {
            background-color: var(--surface-light);
            border-radius: 4px;
        }

        .sidebar {
            width: 320px;
            padding: 1rem;
            background-color: var(--surface-dark);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            height: 100vh;
            position: fixed;
            top: 0;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .left-sidebar {
            border-left: none;
            border-right: 1px solid var(--border);
            left: -320px;
        }

        .right-sidebar {
            right: -320px;
        }

        .sidebar.active {
            transform: translateX(320px);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
        }

        .header {
            width: 100%;
            background-color: var(--surface-dark);
            color: white;
            text-align: center;
            padding: 1rem 0;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            border-radius: 8px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #ff4500, #ff8c00);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #ff4500, #ff8c00);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #canvas-container {
            position: relative;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            border-radius: 8px;
            background-image: 
                linear-gradient(45deg, var(--grid-color) 25%, transparent 25%), 
                linear-gradient(-45deg, var(--grid-color) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, var(--grid-color) 75%), 
                linear-gradient(-45deg, transparent 75%, var(--grid-color) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        #place-canvas {
            background-color: transparent;
            image-rendering: pixelated;
            cursor: crosshair;
            display: block;
        }

        .hover-pixel {
            position: absolute;
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 10;
            mix-blend-mode: difference;
        }

        .color-picker {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 1.5rem 0;
            max-width: 500px;
            background-color: var(--surface);
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            gap: 8px;
        }

        .color-option {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .color-option:hover {
            transform: scale(1.15);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .color-option.selected {
            border: 2px solid white;
            transform: scale(1.15);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .color-option.selected::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 15px;
            height: 15px;
            background-color: var(--primary);
            transform: rotate(45deg);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 12px;
            width: 100%;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 8px 0;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }

        #zoom-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(255, 69, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background-color: var(--surface-light);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none !important;
            box-shadow: none !important;
        }

        button.secondary {
            background-color: var(--surface);
            color: var(--text-primary);
        }

        button.secondary:hover {
            background-color: var(--surface-light);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button.icon-button {
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        #cooldown {
            font-weight: 600;
            color: var(--primary);
            margin-top: 0.5rem;
            padding: 10px 16px;
            border-radius: 24px;
            background-color: var(--surface);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .cooldown-active {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .timer-circle {
            position: relative;
            width: 24px;
            height: 24px;
        }

        .timer-circle svg {
            transform: rotate(-90deg);
        }

        .timer-circle circle {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
        }

        .timer-bg {
            stroke: var(--surface-light);
        }

        .timer-progress {
            stroke: var(--primary);
            transition: stroke-dashoffset 1s linear;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 700px;
            margin-top: 1.5rem;
            padding: 16px;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            gap: 16px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 12px;
            flex: 1;
            min-width: 120px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #ff8c00);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #coordinates {
            padding: 10px 16px;
            font-family: 'Fira Code', monospace;
            background-color: var(--surface);
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .history-viewer {
            width: 100%;
            margin-top: 1.5rem;
            padding: 20px;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .history-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 12px;
            scrollbar-width: thin;
            scrollbar-color: var(--surface-light) var(--surface);
        }

        .history-container::-webkit-scrollbar {
            height: 6px;
        }

        .history-container::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 3px;
        }

        .history-container::-webkit-scrollbar-thumb {
            background-color: var(--surface-light);
            border-radius: 3px;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background-color: var(--surface-light);
            border-radius: 8px;
            font-size: 0.9rem;
            white-space: nowrap;
            flex-shrink: 0;
            transition: transform 0.2s ease;
        }

        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .history-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            display: inline-block;
            flex-shrink: 0;
        }

        .history-username {
            font-weight: 600;
            color: var(--primary);
        }

        .history-coords {
            font-family: 'Fira Code', monospace;
            color: var(--text-secondary);
        }

        .history-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .leaderboard {
            width: 100%;
            margin-top: 1.5rem;
            padding: 20px;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .leaderboard-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .leaderboard-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: var(--surface-light);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .leaderboard-user {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .leaderboard-count {
            color: var(--primary);
            font-weight: 700;
        }

        .leaderboard-position {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--surface-dark);
            border-radius: 50%;
            font-weight: 700;
            color: var(--primary);
            margin-right: 12px;
            flex-shrink: 0;
        }

        .position-1 {
            background: linear-gradient(135deg, #ffd700, #ff9800);
            color: #000;
        }

        .position-2 {
            background: linear-gradient(135deg, #c0c0c0, #9e9e9e);
            color: #000;
        }

        .position-3 {
            background: linear-gradient(135deg, #cd7f32, #8d6e63);
            color: #fff;
        }

        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 16px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .username-box {
            background-color: var(--surface-dark);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 380px;
            max-width: 95%;
            text-align: center;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .username-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-weight: 700;
            background: linear-gradient(135deg, #ff4500, #ff8c00);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .username-input {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background-color: var(--surface);
            border: 2px solid var(--border);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .username-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.2);
        }

        .username-submit {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #ff4500, #ff8c00);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .username-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 69, 0, 0.3);
        }

        .username-submit:active {
            transform: translateY(0);
        }

        .discord-widget {
            width: 100%;
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.5rem;
            padding: 12px;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff4500, #ff8c00);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .user-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success);
        }

        .logout-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
            padding: 6px 10px;
            border-radius: 6px;
        }

        .logout-btn:hover {
            color: var(--text-primary);
            background-color: rgba(255, 69, 0, 0.1);
        }

        #notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: var(--surface-dark);
            color: white;
            padding: 14px 20px;
            border-radius: 8px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 100;
            animation: slideIn 0.3s ease-out;
            max-width: 320px;
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-success {
            border-left-color: var(--success);
        }

        .notification-error {
            border-left-color: var(--error);
        }

        .notification-icon {
            font-size: 1.2rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .tooltip {
            position: absolute;
            background-color: var(--surface-dark);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.2s ease;
            max-width: 200px;
            border: 1px solid var(--border);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px 5px 0;
            border-style: solid;
            border-color: var(--surface-dark) transparent transparent;
        }

        .color-option:hover .tooltip {
            opacity: 1;
        }

        .context-menu {
            position: absolute;
            background-color: var(--surface-dark);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            width: 200px;
            border: 1px solid var(--border);
            overflow: hidden;
            display: none;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s ease;
        }

        .context-menu-item:hover {
            background-color: var(--surface);
        }

        .context-menu-divider {
            height: 1px;
            background-color: var(--border);
            margin: 4px 0;
        }

        .pixel-info {
            position: absolute;
            background-color: var(--surface-dark);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            border: 1px solid var(--border);
            display: none;
            max-width: 240px;
        }

        .pixel-info-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .pixel-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .pixel-coords {
            font-family: 'Fira Code', monospace;
            font-weight: 600;
        }

        .pixel-user {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        .pixel-user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }

        .pixel-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .tab {
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 500;
        }

        .settings-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--surface-light);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .custom-color-input {
            width: 60px;
            height: 36px;
            padding: 2px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: none;
            cursor: pointer;
        }

        .custom-color-input::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .custom-color-input::-moz-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .eraser-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: var(--surface-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eraser-toggle:hover {
            background-color: var(--surface);
        }

        .eraser-toggle.active {
            background-color: rgba(255, 69, 0, 0.2);
            border: 1px solid var(--primary);
        }

        .eraser-icon {
            color: var(--error);
        }

        .timelapse-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .timelapse-content {
            background-color: var(--surface-dark);
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: auto;
        }

        .timelapse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .timelapse-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .timelapse-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .timelapse-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 1.5rem;
        }

        .timelapse-slider {
            width: 100%;
            margin: 1rem 0;
        }

        .timelapse-canvas-container {
            position: relative;
            margin: 0 auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .timelapse-canvas {
            display: block;
            image-rendering: pixelated;
            background-color: white;
        }

        .timelapse-info {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .empty-state-text {
            max-width: 300px;
        }

        /* Hamburger menu */
        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 101;
            background-color: var(--surface-dark);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .menu-toggle:hover {
            background-color: var(--surface);
        }

        .menu-toggle i {
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .right-menu-toggle {
            left: auto;
            right: 20px;
        }

        /* Overlay for when menu is open */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .sidebar {
                width: 280px;
            }
        }

        @media (max-width: 992px) {
            body {
                flex-direction: column;
                overflow-y: auto;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                border-left: none;
                border-right: none;
                border-top: 1px solid var(--border);
                order: 2;
            }
            
            .main-content {
                order: 1;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            .left-sidebar.collapsed {
                transform: translateX(100%);
            }
            
            .discord-widget {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .color-picker {
                max-width: 100%;
            }
            
            .stats-container {
                flex-wrap: wrap;
            }
            
            .stat-item {
                width: 50%;
                margin-bottom: 12px;
            }
            
            .control-group {
                flex-direction: column;
                gap: 12px;
            }
            
            #zoom-controls {
                order: 2;
            }
            
            .header {
                padding: 0.75rem 0;
            }
            
            .logo-icon {
                font-size: 24px;
            }
            
            .logo-text {
                font-size: 20px;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
            }
            
            .logout-btn {
                margin-left: 0;
                margin-top: 8px;
            }
        }

        @media (max-width: 576px) {
            .stat-item {
                width: 100%;
            }
            
            .username-box {
                padding: 1.5rem;
            }
            
            .username-title {
                font-size: 1.5rem;
            }
            
            .history-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                padding: 8px 12px;
            }
            
            .leaderboard-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 10px 12px;
            }
            
            .leaderboard-user {
                width: 100%;
            }
            
            .leaderboard-count {
                margin-left: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Hamburger menu buttons -->
    <button class="menu-toggle" id="left-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>
    <button class="menu-toggle right-menu-toggle" id="right-menu-toggle">
        <i class="fas fa-users"></i>
    </button>
    
    <!-- Overlay for when menu is open -->
    <div class="overlay" id="overlay"></div>

    <div class="sidebar left-sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">User Profile</h3>
            <button class="sidebar-toggle" id="left-sidebar-toggle">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="user-info" id="user-info" style="display: none;">
            <div class="user-avatar" id="user-avatar">U</div>
            <div class="user-details">
                <div class="user-name" id="username-display">Username</div>
                <div class="user-status">
                    <span class="status-indicator"></span>
                    <span>Online</span>
                </div>
            </div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="leaderboard">Leaderboard</div>
            <div class="tab" data-tab="settings">Settings</div>
        </div>
        
        <div class="tab-content active" id="leaderboard-tab">
            <div class="leaderboard">
                <div class="leaderboard-title">
                    <i class="fas fa-trophy"></i>
                    Top Contributors
                </div>
                <div class="leaderboard-container" id="leaderboard-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-spinner loading-spinner"></i>
                        </div>
                        <div class="empty-state-text">Loading leaderboard...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="settings-tab">
            <div class="settings-option">
                <div>
                    <div class="settings-label">Dark Mode</div>
                    <div class="settings-description">Toggle between light and dark theme</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-option">
                <div>
                    <div class="settings-label">Grid Visibility</div>
                    <div class="settings-description">Show/hide the background grid</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="grid-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-option">
                <div>
                    <div class="settings-label">Hover Preview</div>
                    <div class="settings-description">Show pixel placement preview</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="hover-preview-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-option">
                <div>
                    <div class="settings-label">Pixel Sounds</div>
                    <div class="settings-description">Play sound effects</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="sound-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <a href="#" class="logo">
                <div class="logo-icon">Astro</div>
                <div class="logo-text">Places</div>
            </a>
        </div>
        
        <div class="container">
            <div class="control-group">
                <div id="cooldown">Ready to place a pixel!</div>
                <div id="coordinates">
                    <i class="fas fa-crosshairs"></i>
                    <span>Hover over canvas</span>
                </div>
            </div>
            
            <div id="canvas-container">
                <canvas id="place-canvas" width="100" height="100"></canvas>
                <div class="hover-pixel" id="hover-pixel"></div>
                <div class="pixel-info" id="pixel-info"></div>
            </div>
            
            <div class="color-picker-container">
                <div class="color-picker" id="color-picker"></div>
                <input type="color" class="custom-color-input" id="custom-color-input" value="#ff4500" title="Custom color">
                <div class="eraser-toggle" id="eraser-toggle">
                    <i class="fas fa-eraser eraser-icon"></i>
                    <span>Eraser</span>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <div id="zoom-controls">
                        <button id="zoom-out" class="icon-button" title="Zoom Out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button id="zoom-reset" title="Reset View">
                            <i class="fas fa-expand"></i>
                            <span>Reset View</span>
                        </button>
                        <button id="zoom-in" class="icon-button" title="Zoom In">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>
                    <button id="timelapse-button">
                        <i class="fas fa-film"></i>
                        <span>View Timelapse</span>
                    </button>
                    <button id="save-image-button" class="secondary">
                        <i class="fas fa-download"></i>
                        <span>Save Image</span>
                    </button>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-item">
                    <div class="stat-value" id="user-count">0</div>
                    <div class="stat-label">Users Online</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pixel-count">0</div>
                    <div class="stat-label">Pixels Placed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="your-pixels">0</div>
                    <div class="stat-label">Your Pixels</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="canvas-size">100x100</div>
                    <div class="stat-label">Canvas Size</div>
                </div>
            </div>
            
            <div class="history-viewer">
                <div class="history-title">
                    <i class="fas fa-history"></i>
                    Recent Activity
                </div>
                <div class="history-container" id="history-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-spinner loading-spinner"></i>
                        </div>
                        <div class="empty-state-text">Loading recent activity...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar right-sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Community</h3>
            <button class="sidebar-toggle" id="right-sidebar-toggle">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="discord-widget">
            <iframe src="https://discord.com/widget?id=1367209579460562964&theme=dark" 
                    width="100%" 
                    height="100%" 
                    allowtransparency="true" 
                    frameborder="0" 
                    sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"></iframe>
        </div>
        
        <div class="leaderboard" style="margin-top: 1.5rem;">
            <div class="leaderboard-title">
                <i class="fas fa-fire"></i>
                Most Active Today
            </div>
            <div class="leaderboard-container" id="daily-leaderboard-container">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-spinner loading-spinner"></i>
                    </div>
                    <div class="empty-state-text">Loading daily stats...</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification-success">
        <i class="fas fa-check-circle notification-icon"></i>
        <div class="notification-content">Pixel placed successfully!</div>
        <button class="notification-close">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="username-modal" id="username-modal">
        <div class="username-box">
            <div class="username-title">Welcome to Astro Places</div>
            <input type="text" class="username-input" id="username-input" placeholder="Enter your username" maxlength="16">
            <button class="username-submit" id="username-submit">
                <i class="fas fa-paint-brush"></i>
                <span>Start Placing</span>
            </button>
        </div>
    </div>
    
    <div class="timelapse-container" id="timelapse-container">
        <div class="timelapse-content">
            <div class="timelapse-header">
                <h2 class="timelapse-title">
                    <i class="fas fa-film"></i>
                    Canvas Timelapse
                </h2>
                <button class="timelapse-close" id="timelapse-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="timelapse-controls">
                <button id="timelapse-play" class="secondary">
                    <i class="fas fa-play"></i>
                    <span>Play</span>
                </button>
                <button id="timelapse-pause" class="secondary" disabled>
                    <i class="fas fa-pause"></i>
                    <span>Pause</span>
                </button>
                <button id="timelapse-export" class="secondary">
                    <i class="fas fa-download"></i>
                    <span>Export</span>
                </button>
            </div>
            
            <input type="range" class="timelapse-slider" id="timelapse-slider" min="0" max="100" value="0">
            
            <div class="timelapse-canvas-container">
                <canvas id="timelapse-canvas" width="500" height="500"></canvas>
            </div>
            
            <div class="timelapse-info">
                <div id="timelapse-time">Time: 00:00</div>
                <div id="timelapse-frame">Frame: 0/0</div>
            </div>
        </div>
    </div>
    
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" id="copy-coords">
            <i class="fas fa-copy"></i>
            <span>Copy Coordinates</span>
        </div>
        <div class="context-menu-item" id="view-pixel-info">
            <i class="fas fa-info-circle"></i>
            <span>Pixel Info</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="jump-to-pixel">
            <i class="fas fa-location-arrow"></i>
            <span>Jump to Pixel</span>
        </div>
    </div>

    <audio id="place-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="error-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-688.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, get, push, remove, update, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
       
        const firebaseConfig = {
            apiKey: "AIzaSyCpOUr78CAyGatrQdVOw6yf8EK4OvtoMoo",
            authDomain: "astro-places-1aec2.firebaseapp.com",
            projectId: "astro-places-1aec2",
            storageBucket: "astro-places-1aec2.appspot.com",
            messagingSenderId: "502500788903",
            appId: "1:502500788903:web:5f742fd1ad5cce9063e982",
            measurementId: "G-6J7SM1KM05",
            databaseURL: "https://astro-places-1aec2-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const analytics = getAnalytics(app);

        // Log app open event
        logEvent(analytics, 'app_open');

        // Utility functions
        function throttle(func, limit) {
            let lastFunc;
            let lastRan;
            return function() {
                const context = this;
                const args = arguments;
                if (!lastRan) {
                    func.apply(context, args);
                    lastRan = Date.now();
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(function() {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(context, args);
                            lastRan = Date.now();
                        }
                    }, limit - (Date.now() - lastRan));
                }
            };
        }

        function debounce(func, wait, immediate) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                const later = function() {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(context, args);
            };
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }

        function hexToRgb(hex) {
            // Remove # if present
            hex = hex.replace('#', '');
            
            // Parse r, g, b values
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            return { r, g, b };
        }

        function getContrastColor(hexColor) {
            // Convert hex to RGB
            const rgb = hexToRgb(hexColor);
            
            // Calculate luminance
            const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
            
            // Return black for light colors, white for dark colors
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }

        // Canvas setup
        const canvas = document.getElementById('place-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        let canvasSize = 450; // Default size (will be updated from Firebase)
        const pixelSize = 4; // Size of each pixel for rendering
        
        // Current view properties
        let zoom = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let currentHoverX = -1;
        let currentHoverY = -1;
        
        // User interaction
        let selectedColor = '#ff4500';
        let lastPlacedTime = 0;
        const cooldownTime = 200; // 5 seconds cooldown
        let userId = '';
        let username = '';
        let userPresenceRef = null;
        let myPixelCount = 0;
        let totalPixelCount = 0;
        
        // Hover preview
        const hoverPixel = document.getElementById('hover-pixel');
        
        // Color palette
        const colors = [
            { hex: '#FFFFFF', name: 'White' },
            { hex: '#D4D7D9', name: 'Light Gray' },
            { hex: '#898D90', name: 'Gray' },
            { hex: '#515252', name: 'Dark Gray' },
            { hex: '#000000', name: 'Black' },
            { hex: '#D80000', name: 'Red' },
            { hex: '#FF4500', name: 'Orange Red' },
            { hex: '#FFA800', name: 'Orange' },
            { hex: '#FFD635', name: 'Yellow' },
            { hex: '#00A368', name: 'Green' },
            { hex: '#7EED56', name: 'Light Green' },
            { hex: '#2450A4', name: 'Dark Blue' },
            { hex: '#3690EA', name: 'Blue' },
            { hex: '#51E9F4', name: 'Cyan' },
            { hex: '#811E9F', name: 'Purple' },
            { hex: '#B44AC0', name: 'Light Purple' },
            { hex: '#FF99AA', name: 'Pink' },
            { hex: '#6A5CFF', name: 'Periwinkle' },
            { hex: '#E4ABFF', name: 'Lavender' },
            { hex: '#BE0039', name: 'Dark Red' },
            { hex: '#FF3881', name: 'Hot Pink' },
            { hex: '#493AC1', name: 'Indigo' },
            { hex: '#6D001A', name: 'Maroon' },
            { hex: '#6D482F', name: 'Brown' },
            { hex: '#9C6926', name: 'Light Brown' },
            { hex: '#008080', name: 'Teal' },
            { hex: '#00CED1', name: 'Turquoise' },
            { hex: '#20B2AA', name: 'Sea Green' },
            { hex: '#556B2F', name: 'Olive' },
            { hex: '#8FBC8F', name: 'Sage' },
            { hex: '#F08080', name: 'Coral' },
            { hex: '#FA8072', name: 'Salmon' },
            { hex: '#FFDAB9', name: 'Peach' },
            { hex: '#FFB6C1', name: 'Light Pink' },
            { hex: '#DB7093', name: 'Pale Violet' },
            { hex: '#9370DB', name: 'Medium Purple' },
            { hex: '#BA55D3', name: 'Orchid' },
            { hex: '#8A2BE2', name: 'Blue Violet' },
            { hex: '#4B0082', name: 'Indigo' },
            { hex: '#4169E1', name: 'Royal Blue' },
            { hex: '#00BFFF', name: 'Deep Sky Blue' },
            { hex: '#1E90FF', name: 'Dodger Blue' },
            { hex: '#7B68EE', name: 'Medium Slate Blue' },
            { hex: '#FF6347', name: 'Tomato' },
            { hex: '#FF7F50', name: 'Coral' },
            { hex: '#FFA07A', name: 'Light Salmon' },
            { hex: '#EEE8AA', name: 'Pale Goldenrod' },
            { hex: '#98FB98', name: 'Mint' },
            { hex: '#ADFF2F', name: 'Green Yellow' }
        ];

        // Track user pixel counts for leaderboard
        const userPixelCounts = {};
        const usernames = {};
        const dailyPixelCounts = {};

        // Create color picker with tooltips
        const colorPicker = document.getElementById('color-picker');
        colors.forEach(color => {
            const colorOption = document.createElement('div');
            colorOption.className = 'color-option';
            colorOption.style.backgroundColor = color.hex;
            colorOption.dataset.color = color.hex;
            colorOption.dataset.name = color.name;
            
            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = color.name;
            colorOption.appendChild(tooltip);
            
            colorOption.addEventListener('click', () => {
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                colorOption.classList.add('selected');
                selectedColor = color.hex;
                
                // Update hover preview
                if (hoverPixel.style.display === 'block') {
                    hoverPixel.style.backgroundColor = color.hex;
                }
                
                // Disable eraser if it was active
                document.getElementById('eraser-toggle').classList.remove('active');
                
                // Play sound if enabled
                playSound('click');
            });
            colorPicker.appendChild(colorOption);
        });
        
        // Select the first color by default
        document.querySelector('.color-option').classList.add('selected');

        // Custom color input
        const customColorInput = document.getElementById('custom-color-input');
        customColorInput.addEventListener('input', (e) => {
            selectedColor = e.target.value;
            
            // Update selected color in picker
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            
            // Disable eraser if it was active
            document.getElementById('eraser-toggle').classList.remove('active');
            
            // Update hover preview
            if (hoverPixel.style.display === 'block') {
                hoverPixel.style.backgroundColor = selectedColor;
            }
        });

        // Eraser toggle
        const eraserToggle = document.getElementById('eraser-toggle');
        eraserToggle.addEventListener('click', () => {
            eraserToggle.classList.toggle('active');
            
            if (eraserToggle.classList.contains('active')) {
                selectedColor = '#FFFFFF'; // White is our "eraser"
                
                // Deselect any color
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                
                // Update hover preview
                if (hoverPixel.style.display === 'block') {
                    hoverPixel.style.backgroundColor = '#FFFFFF';
                }
            } else {
                // Reselect the previously selected color
                const selected = document.querySelector('.color-option.selected');
                if (selected) {
                    selectedColor = selected.dataset.color;
                    
                    // Update hover preview
                    if (hoverPixel.style.display === 'block') {
                        hoverPixel.style.backgroundColor = selectedColor;
                    }
                }
            }
            
            // Play sound if enabled
            playSound('click');
        });

        // Resize canvas element based on zoom level
        function resizeCanvas() {
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            canvas.style.width = (canvasSize * pixelSize * zoom) + 'px';
            canvas.style.height = (canvasSize * pixelSize * zoom) + 'px';
            document.getElementById('canvas-container').style.width = (canvasSize * pixelSize * zoom) + 'px';
            document.getElementById('canvas-container').style.height = (canvasSize * pixelSize * zoom) + 'px';
            
            // Update hover pixel size
            hoverPixel.style.width = (pixelSize * zoom) + 'px';
            hoverPixel.style.height = (pixelSize * zoom) + 'px';
            
            // Update canvas size display
            document.getElementById('canvas-size').textContent = `${canvasSize}x${canvasSize}`;
            
            // Mark canvas for redraw
            canvas.needsRedraw = true;
            drawCanvas();
        }

        // Optimized canvas drawing with buffering and requestAnimationFrame
        function drawCanvas() {
            // Only redraw when necessary
            if (!canvas.needsRedraw) return;
            canvas.needsRedraw = false;
            
            // Create buffer if it doesn't exist
            if (!canvas.buffer) {
                canvas.buffer = document.createElement('canvas');
                canvas.buffer.width = canvas.width;
                canvas.buffer.height = canvas.height;
                canvas.bufferCtx = canvas.buffer.getContext('2d');
                canvas.backgroundDrawn = false;
            }
            
            // Draw grid background only once if enabled
            const gridEnabled = document.getElementById('grid-toggle').checked;
            if (!canvas.backgroundDrawn || canvas.gridEnabled !== gridEnabled) {
                canvas.bufferCtx.fillStyle = '#FFFFFF';
                canvas.bufferCtx.fillRect(0, 0, canvas.width, canvas.height);
                
                if (gridEnabled) {
                    canvas.bufferCtx.fillStyle = '#F0F0F0';
                    for (let x = 0; x < canvas.width; x += 10) {
                        for (let y = 0; y < canvas.height; y += 10) {
                            if ((x + y) % 20 === 0) {
                                canvas.bufferCtx.fillRect(x, y, 1, 1);
                            }
                        }
                    }
                }
                
                canvas.backgroundDrawn = true;
                canvas.gridEnabled = gridEnabled;
            }
            
            // Get pixels from Firebase
            const pixelsRef = ref(db, 'pixels');
            onValue(pixelsRef, (snapshot) => {
                const pixelData = snapshot.val() || {};
                
                requestAnimationFrame(() => {
                    // Clear only the buffer
                    canvas.bufferCtx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw background
                    canvas.bufferCtx.fillStyle = '#FFFFFF';
                    canvas.bufferCtx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    if (gridEnabled) {
                        canvas.bufferCtx.fillStyle = '#F0F0F0';
                        for (let x = 0; x < canvas.width; x += 10) {
                            for (let y = 0; y < canvas.height; y += 10) {
                                if ((x + y) % 20 === 0) {
                                    canvas.bufferCtx.fillRect(x, y, 1, 1);
                                }
                            }
                        }
                    }
                    
                    totalPixelCount = 0;
                    myPixelCount = 0;
                    
                    // Reset user pixel counts for leaderboard
                    for (const userId in userPixelCounts) {
                        userPixelCounts[userId] = 0;
                    }
                    
                    // Batch pixel updates
                    for (const key in pixelData) {
                        const [x, y] = key.split(',');
                        const xInt = parseInt(x);
                        const yInt = parseInt(y);
                        
                        if (xInt >= 0 && xInt < canvasSize && yInt >= 0 && yInt < canvasSize) {
                            const pixelValue = pixelData[key];
                            let pixelColor;
                            
                            if (typeof pixelValue === 'string') {
                                pixelColor = pixelValue.startsWith('#') ? pixelValue : `#${pixelValue}`;
                            } else if (pixelValue?.color) {
                                pixelColor = pixelValue.color.startsWith('#') ? pixelValue.color : `#${pixelValue.color}`;
                            } else {
                                pixelColor = '#FFFFFF';
                            }
                            
                            canvas.bufferCtx.fillStyle = pixelColor;
                            canvas.bufferCtx.fillRect(xInt, yInt, 1, 1);
                            totalPixelCount++;
                            
                            if (typeof pixelValue === 'object' && pixelValue?.userId) {
                                const userId = pixelValue.userId;
                                userPixelCounts[userId] = (userPixelCounts[userId] || 0) + 1;
                                
                                if (userId === userId) {
                                    myPixelCount++;
                                }
                                
                                // Track usernames
                                if (pixelValue.username) {
                                    usernames[userId] = pixelValue.username;
                                }
                            }
                        }
                    }
                    
                    // Draw the buffer to the main canvas in one operation
                    ctx.drawImage(canvas.buffer, 0, 0);
                    
                    // Update counters
                    document.getElementById('pixel-count').textContent = totalPixelCount.toLocaleString();
                    document.getElementById('your-pixels').textContent = myPixelCount.toLocaleString();
                    
                    // Update leaderboard
                    updateLeaderboard();
                });
            }, {
                // Only retrieve the data once unless it changes
                onlyOnce: false
            });
        }

        // Place pixel with cooldown and error handling
        async function placePixel(x, y) {
            if (!userId || !username) {
                showNotification('Please set a username first', 'error');
                return;
            }

            const now = Date.now();

            // Check cooldown
            if (now - lastPlacedTime < cooldownTime) {
                const remaining = Math.ceil((cooldownTime - (now - lastPlacedTime)) / 1000);
                showNotification(`Please wait ${remaining} more seconds`, 'error');
                playSound('error');
                return;
            }

            // Ensure coordinates are within bounds
            if (x < 0 || x >= canvasSize || y < 0 || y >= canvasSize) {
                showNotification('Pixel is outside canvas bounds', 'error');
                playSound('error');
                return;
            }

            const pixelRef = ref(db, `pixels/${x},${y}`);
            
            // Get current pixel data to check if it's the same color
            try {
                const snapshot = await get(pixelRef);
                const currentPixel = snapshot.val();
                
                // Check if pixel is already the same color
                if (currentPixel && typeof currentPixel === 'object' && currentPixel.color) {
                    if (currentPixel.color === selectedColor.replace('#', '')) {
                        showNotification('Pixel is already this color', 'error');
                        playSound('error');
                        return;
                    }
                } else if (typeof currentPixel === 'string' && currentPixel === selectedColor.replace('#', '')) {
                    showNotification('Pixel is already this color', 'error');
                    playSound('error');
                    return;
                }
                
                // Also check if this user already placed this pixel recently
                if (currentPixel && currentPixel.userId === userId && (now - currentPixel.timestamp < cooldownTime * 2)) {
                    showNotification('You recently placed this pixel', 'error');
                    playSound('error');
                    return;
                }
            } catch (error) {
                console.error("Error checking pixel:", error);
            }

            if (selectedColor === '#FFFFFF') {
                // White color will delete the pixel
                try {
                    await remove(pixelRef);
                    lastPlacedTime = now;
                    updateCooldown();
                    addToHistory(x, y, 'erased');
                    showNotification('Pixel erased successfully!', 'success');
                    playSound('place');
                    
                    // Log pixel erase event
                    logEvent(analytics, 'pixel_erased', {
                        x: x,
                        y: y,
                        user_id: userId
                    });
                } catch (error) {
                    console.error("Error erasing pixel: ", error);
                    showNotification('Error erasing pixel', 'error');
                    playSound('error');
                }
            } else {
  
                try {
                    await set(pixelRef, {
                        color: selectedColor.replace('#', ''),
                        userId: userId,
                        username: username,
                        timestamp: now
                    });
                    lastPlacedTime = now;
                    updateCooldown();
                    addToHistory(x, y, selectedColor);
                    showNotification('Pixel placed successfully!', 'success');
                    playSound('place');
                    
                    // Log pixel place event
                    logEvent(analytics, 'pixel_placed', {
                        x: x,
                        y: y,
                        color: selectedColor,
                        user_id: userId
                    });
                    
                    // Update daily count
                    updateDailyPixelCount();
                } catch (error) {
                    console.error("Error placing pixel: ", error);
                    showNotification('Error placing pixel', 'error');
                    playSound('error');
                }
            }
            
            // Mark canvas for redraw
            canvas.needsRedraw = true;
        }

        // Update daily pixel count for leaderboard
        function updateDailyPixelCount() {
            if (!userId) return;
            
            const today = new Date().toISOString().split('T')[0];
            const dailyRef = ref(db, `dailyCounts/${today}/${userId}`);
            
            get(dailyRef).then((snapshot) => {
                const currentCount = snapshot.val() || 0;
                set(dailyRef, currentCount + 1);
            });
        }

        // Update cooldown timer with circle animation
        function updateCooldown() {
            const cooldownElement = document.getElementById('cooldown');
            const now = Date.now();
            
            if (now - lastPlacedTime < cooldownTime) {
                const remainingTime = Math.ceil((cooldownTime - (now - lastPlacedTime)) / 1000);
                const percentage = ((cooldownTime - (now - lastPlacedTime)) / cooldownTime) * 100;
                
                // Create timer circle if needed
                if (!document.querySelector('.timer-circle')) {
                    cooldownElement.innerHTML = '';
                    cooldownElement.classList.add('cooldown-active');
                    
                    const timerCircle = document.createElement('div');
                    timerCircle.className = 'timer-circle';
                    timerCircle.innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <circle class="timer-bg" cx="12" cy="12" r="10" />
                            <circle class="timer-progress" cx="12" cy="12" r="10" stroke-dasharray="62.8" stroke-dashoffset="0" />
                        </svg>
                    `;
                    
                    const timerText = document.createElement('span');
                    timerText.className = 'timer-text';
                    timerText.textContent = `${remainingTime}s`;
                    
                    cooldownElement.appendChild(timerCircle);
                    cooldownElement.appendChild(timerText);
                }
                
                // Update timer progress
                const progressCircle = document.querySelector('.timer-progress');
                const timerText = document.querySelector('.timer-text');
                
                const circumference = 2 * Math.PI * 10; // r=10
                const offset = circumference - (percentage / 100) * circumference;
                progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
                progressCircle.style.strokeDashoffset = offset;
                
                timerText.textContent = `${remainingTime}s`;
                
                setTimeout(updateCooldown, 50);
            } else {
                cooldownElement.classList.remove('cooldown-active');
                cooldownElement.innerHTML = 'Ready to place a pixel!';
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification-${type}`;
            
            // Update icon based on type
            const icon = notification.querySelector('.notification-icon');
            if (type === 'success') {
                icon.className = 'fas fa-check-circle notification-icon';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle notification-icon';
            }
            
            // Show notification
            notification.style.display = 'flex';
            
            // Auto-hide after 3 seconds
            clearTimeout(notification.hideTimeout);
            notification.hideTimeout = setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Close notification manually
        document.querySelector('.notification-close').addEventListener('click', () => {
            const notification = document.getElementById('notification');
            notification.style.display = 'none';
            clearTimeout(notification.hideTimeout);
        });

        // Play sound effects
        function playSound(type) {
            if (!document.getElementById('sound-toggle').checked) return;
            
            try {
                const sound = type === 'place' ? document.getElementById('place-sound') : document.getElementById('error-sound');
                sound.currentTime = 0;
                sound.play();
            } catch (e) {
                console.error("Error playing sound:", e);
            }
        }

        // Add to history log
        function addToHistory(x, y, color) {
            // Add to Firebase history
            const historyRef = ref(db, 'history');
            push(historyRef, {
                x: x,
                y: y,
                color: color,
                userId: userId,
                username: username,
                timestamp: Date.now()
            });
            
            // Also add to local history for immediate feedback
            updateHistoryDisplay({
                x: x,
                y: y,
                color: color,
                userId: userId,
                username: username,
                timestamp: Date.now()
            }, true);
        }

        // Update history display
        function updateHistoryDisplay(historyItem, prepend = false) {
            const historyContainer = document.getElementById('history-container');
            
            // Remove empty state if present
            const emptyState = historyContainer.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const historyElement = document.createElement('div');
            historyElement.className = 'history-item';
            
            const colorDisplay = color === 'erased' ? '#FFFFFF' : color;
            const actionText = color === 'erased' ? 'erased a pixel at' : 'placed a pixel at';
            
            historyElement.innerHTML = `
                <div class="history-color" style="background-color: ${colorDisplay};"></div>
                <span class="history-username">${historyItem.username || 'Anonymous'}</span>
                <span>${actionText}</span>
                <span class="history-coords">(${historyItem.x}, ${historyItem.y})</span>
                <span class="history-time">${formatTime(historyItem.timestamp)}</span>
            `;
            
            if (prepend && historyContainer.firstChild) {
                historyContainer.insertBefore(historyElement, historyContainer.firstChild);
            } else {
                historyContainer.appendChild(historyElement);
            }
            
            // Limit to 50 items
            if (historyContainer.children.length > 50) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
            
            // Scroll to top if prepended
            if (prepend) {
                historyContainer.scrollLeft = 0;
            }
        }

        // Load history from Firebase
        function loadHistory() {
            const historyRef = query(ref(db, 'history'), orderByChild('timestamp'), limitToLast(20));
            
            onValue(historyRef, (snapshot) => {
                const historyData = snapshot.val() || {};
                const historyContainer = document.getElementById('history-container');
                
                // Clear existing items except empty state
                const emptyState = historyContainer.querySelector('.empty-state');
                historyContainer.innerHTML = '';
                if (emptyState) {
                    historyContainer.appendChild(emptyState);
                }
                
                // Convert to array and sort by timestamp
                const historyArray = Object.values(historyData).sort((a, b) => b.timestamp - a.timestamp);
                
                if (historyArray.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.innerHTML = `
                        <div class="empty-state-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="empty-state-text">No recent activity yet</div>
                    `;
                    historyContainer.appendChild(emptyState);
                } else {
                    historyArray.forEach(item => {
                        updateHistoryDisplay(item);
                    });
                }
            });
        }

        // Update the leaderboard display
        function updateLeaderboard() {
            const leaderboardContainer = document.getElementById('leaderboard-container');
            
            // Convert to array and sort by pixel count
            const sortedUsers = Object.entries(userPixelCounts)
                .map(([userId, count]) => ({ 
                    userId, 
                    count,
                    username: usernames[userId] || 'Anonymous'
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 30); // Top 10 users
            
            // Create leaderboard HTML
            const fragment = document.createDocumentFragment();
            
            // Add header
            const header = document.createElement('div');
            header.className = 'leaderboard-header';
            header.innerHTML = `
                <span>User</span>
                <span>Pixels</span>
            `;
            fragment.appendChild(header);
            
            // Add users
            sortedUsers.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                const positionClass = index < 3 ? `position-${index + 1}` : '';
                
                item.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <span class="leaderboard-position ${positionClass}">${index + 1}</span>
                        <span class="leaderboard-user">${user.username}</span>
                    </div>
                    <span class="leaderboard-count">${user.count.toLocaleString()}</span>
                `;
                fragment.appendChild(item);
            });
            
            if (sortedUsers.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="empty-state-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="empty-state-text">No leaderboard data yet</div>
                `;
                fragment.appendChild(emptyState);
            }
            
            leaderboardContainer.innerHTML = '';
            leaderboardContainer.appendChild(fragment);
        }

        // Update daily leaderboard
        function updateDailyLeaderboard() {
            const today = new Date().toISOString().split('T')[0];
            const dailyRef = ref(db, `dailyCounts/${today}`);
            
            onValue(dailyRef, (snapshot) => {
                const dailyData = snapshot.val() || {};
                const dailyLeaderboard = document.getElementById('daily-leaderboard-container');
                
                // Convert to array and sort
                const sortedDaily = Object.entries(dailyData)
                    .map(([userId, count]) => ({
                        userId,
                        count,
                        username: usernames[userId] || 'Anonymous'
                    }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5); // Top 5 daily
                
                const fragment = document.createDocumentFragment();
                
                // Add header
                const header = document.createElement('div');
                header.className = 'leaderboard-header';
                header.innerHTML = `
                    <span>Today's Top</span>
                    <span>Pixels</span>
                `;
                fragment.appendChild(header);
                
                // Add users
                sortedDaily.forEach((user, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    
                    item.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <span class="leaderboard-user">${user.username}</span>
                        </div>
                        <span class="leaderboard-count">${user.count}</span>
                    `;
                    fragment.appendChild(item);
                });
                
                if (sortedDaily.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.innerHTML = `
                        <div class="empty-state-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="empty-state-text">No activity today yet</div>
                    `;
                    fragment.appendChild(emptyState);
                }
                
                dailyLeaderboard.innerHTML = '';
                dailyLeaderboard.appendChild(fragment);
            });
        }

        // Generate a random user ID
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        // Save user data to localStorage
        function saveUserData() {
            localStorage.setItem('astroPlacesUser', JSON.stringify({
                userId: userId,
                username: username,
                settings: {
                    darkMode: document.getElementById('dark-mode-toggle').checked,
                    gridVisible: document.getElementById('grid-toggle').checked,
                    hoverPreview: document.getElementById('hover-preview-toggle').checked,
                    soundEnabled: document.getElementById('sound-toggle').checked
                }
            }));
        }

        // Load user data from localStorage
        function loadUserData() {
            const userData = localStorage.getItem('astroPlacesUser');
            if (userData) {
                try {
                    const data = JSON.parse(userData);
                    return data;
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        // Clear user data from localStorage
        function clearUserData() {
            localStorage.removeItem('astroPlacesUser');
        }

        // Optimized user presence handling
        function setupUserPresence() {
            userPresenceRef = ref(db, `users/${userId}`);
            
            // Set user as online
            set(userPresenceRef, {
                online: true,
                username: username,
                lastActive: Date.now(),
                joinDate: Date.now()
            });
            
            // Update last active time periodically
            setInterval(() => {
                update(userPresenceRef, {
                    lastActive: Date.now()
                });
            }, 30000);
            
            // Listen for all users
            const usersRef = ref(db, 'users');
            let lastUserCountUpdate = 0;
            
            onValue(usersRef, (snapshot) => {
                const now = Date.now();
                // Throttle updates to at most once per 5 seconds
                if (now - lastUserCountUpdate < 5000) return;
                lastUserCountUpdate = now;
                
                const users = snapshot.val() || {};
                const activeUsers = Object.values(users).filter(user => 
                    user.online && (now - user.lastActive < 60000)
                ).length;
                
                document.getElementById('user-count').textContent = activeUsers.toLocaleString();
                
                // Update usernames mapping
                for (const userId in users) {
                    if (users[userId].username) {
                        usernames[userId] = users[userId].username;
                    }
                }
            });
        }

        // Initialize user session
        function initializeUserSession(savedUsername, savedUserId) {
            username = savedUsername;
            userId = savedUserId || generateUserId();
            
            // Update UI
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('username-display').textContent = username;
            document.getElementById('user-avatar').textContent = username.charAt(0).toUpperCase();
            document.getElementById('username-modal').style.display = 'none';
            
            // Save user data
            saveUserData();
            
            // Initialize user presence
            setupUserPresence();
            
            // Load canvas
            const configRef = ref(db, 'config/canvasSize');
            get(configRef).then((snapshot) => {
                if (snapshot.exists()) {
                    canvasSize = snapshot.val();
                }
                resizeCanvas();
                drawCanvas();
            });
            
            // Load history and leaderboards
            loadHistory();
            updateLeaderboard();
            updateDailyLeaderboard();
            
            // Log login event
            logEvent(analytics, 'login', {
                user_id: userId,
                username: username
            });
        }

        // Canvas interaction events
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            
            placePixel(x, y);
        });

        // Right-click context menu
        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            
            // Only show menu if coordinates are valid
            if (x >= 0 && x < canvasSize && y >= 0 && y < canvasSize) {
                const contextMenu = document.getElementById('context-menu');
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${e.clientX}px`;
                contextMenu.style.top = `${e.clientY}px`;
                
                // Store coordinates for menu actions
                contextMenu.dataset.x = x;
                contextMenu.dataset.y = y;
            }
        });

        // Close context menu when clicking elsewhere
        document.addEventListener('click', (e) => {
            const contextMenu = document.getElementById('context-menu');
            if (contextMenu.style.display === 'block' && !contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
        });

        // Context menu actions
        document.getElementById('copy-coords').addEventListener('click', () => {
            const contextMenu = document.getElementById('context-menu');
            const coords = `(${contextMenu.dataset.x}, ${contextMenu.dataset.y})`;
            navigator.clipboard.writeText(coords);
            showNotification('Coordinates copied to clipboard', 'success');
            contextMenu.style.display = 'none';
        });

        document.getElementById('view-pixel-info').addEventListener('click', () => {
            const contextMenu = document.getElementById('context-menu');
            const x = parseInt(contextMenu.dataset.x);
            const y = parseInt(contextMenu.dataset.y);
            showPixelInfo(x, y);
            contextMenu.style.display = 'none';
        });

        document.getElementById('jump-to-pixel').addEventListener('click', () => {
            const contextMenu = document.getElementById('context-menu');
            const x = parseInt(contextMenu.dataset.x);
            const y = parseInt(contextMenu.dataset.y);
            
            // Center view on this pixel
            const container = document.getElementById('canvas-container');
            const centerX = (x * pixelSize * zoom) - (container.clientWidth / 2);
            const centerY = (y * pixelSize * zoom) - (container.clientHeight / 2);
            
            // Smooth scroll to center
            container.scrollTo({
                left: centerX,
                top: centerY,
                behavior: 'smooth'
            });
            
            showNotification(`Jumped to pixel (${x}, ${y})`, 'success');
            contextMenu.style.display = 'none';
        });

        // Show pixel info
        async function showPixelInfo(x, y) {
            const pixelInfo = document.getElementById('pixel-info');
            const pixelRef = ref(db, `pixels/${x},${y}`);
            
            try {
                const snapshot = await get(pixelRef);
                const pixelData = snapshot.val();
                
                if (!pixelData) {
                    pixelInfo.innerHTML = `
                        <div class="pixel-info-header">
                            <div class="pixel-color" style="background-color: #FFFFFF;"></div>
                            <div class="pixel-coords">(${x}, ${y})</div>
                        </div>
                        <div>Empty pixel</div>
                    `;
                } else {
                    const color = typeof pixelData === 'object' ? `#${pixelData.color}` : `#${pixelData}`;
                    const username = pixelData.username || 'NOT FRICKEN BLAKE!';
                    const timestamp = pixelData.timestamp ? formatTime(pixelData.timestamp) : 'pp';
                    
                    pixelInfo.innerHTML = `
                        <div class="pixel-info-header">
                            <div class="pixel-color" style="background-color: ${color};"></div>
                            <div class="pixel-coords">(${x}, ${y})</div>
                        </div>
                        <div class="pixel-user">
                            <div class="pixel-user-avatar">${username.charAt(0).toUpperCase()}</div>
                            <div>${username}</div>
                        </div>
                        <div class="pixel-time">Placed at ${timestamp}</div>
                    `;
                }
                
                // Position near the pixel
                const rect = canvas.getBoundingClientRect();
                const pixelX = (x * pixelSize * zoom) + rect.left;
                const pixelY = (y * pixelSize * zoom) + rect.top;
                
                pixelInfo.style.left = `${pixelX}px`;
                pixelInfo.style.top = `${pixelY + (pixelSize * zoom)}px`;
                pixelInfo.style.display = 'block';
                
                // Hide after 5 seconds or when clicking elsewhere
                setTimeout(() => {
                    pixelInfo.style.display = 'none';
                }, 5000);
            } catch (error) {
                console.error("Error fetching pixel info:", error);
                showNotification('Error loading pixel info', 'error');
            }
        }

        // Hide pixel info when clicking elsewhere
        document.addEventListener('click', (e) => {
            const pixelInfo = document.getElementById('pixel-info');
            if (pixelInfo.style.display === 'block' && !pixelInfo.contains(e.target)) {
                pixelInfo.style.display = 'none';
            }
        });

        // Throttled hover effect
        canvas.addEventListener('mousemove', throttle((e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            
            // Update coordinates display
            document.getElementById('coordinates').innerHTML = `
                <i class="fas fa-crosshairs"></i>
                <span>(${x}, ${y})</span>
            `;
            
            // Store current hover coordinates
            currentHoverX = x;
            currentHoverY = y;
            
            // Show hover preview if enabled
            const hoverEnabled = document.getElementById('hover-preview-toggle').checked;
            
            if (hoverEnabled && x >= 0 && x < canvasSize && y >= 0 && y < canvasSize) {
                hoverPixel.style.display = 'block';
                hoverPixel.style.left = (x * pixelSize * zoom) + 'px';
                hoverPixel.style.top = (y * pixelSize * zoom) + 'px';
                hoverPixel.style.backgroundColor = selectedColor;
            } else {
                hoverPixel.style.display = 'none';
            }
        }, 50));
        
        canvas.addEventListener('mouseout', () => {
            hoverPixel.style.display = 'none';
            currentHoverX = -1;
            currentHoverY = -1;
        });

        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', () => {
            zoom = Math.min(zoom + 0.5, 5);
            resizeCanvas();
            playSound('click');
        });
        
        document.getElementById('zoom-out').addEventListener('click', () => {
            zoom = Math.max(zoom - 0.5, 0.5);
            resizeCanvas();
            playSound('click');
        });
        
        document.getElementById('zoom-reset').addEventListener('click', () => {
            zoom = 1;
            offsetX = 0;
            offsetY = 0;
            resizeCanvas();
            playSound('click');
        });

        // Panning/dragging the canvas with debouncing
        canvas.addEventListener('mousedown', (e) => {
            // Only start dragging on left click
            if (e.button === 0) {
                isDragging = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                canvas.style.cursor = 'grabbing';
            }
        });
        
        window.addEventListener('mousemove', throttle((e) => {
            if (!isDragging) return;
            
            const dx = e.clientX - lastMouseX;
            const dy = e.clientY - lastMouseY;
            
            // Update offsets for panning
            offsetX += dx;
            offsetY += dy;

            lastMouseX = e.clientX;
            lastMouseY = e.clientY;

            // Mark canvas for redraw
            canvas.needsRedraw = true;
        }, 16)); // ~60fps
        
        window.addEventListener('mouseup', () => {
            isDragging = false;
            canvas.style.cursor = 'crosshair';
        });

        // Menu toggle functionality
        const leftMenuToggle = document.getElementById('left-menu-toggle');
        const rightMenuToggle = document.getElementById('right-menu-toggle');
        const leftSidebar = document.querySelector('.left-sidebar');
        const rightSidebar = document.querySelector('.right-sidebar');
        const overlay = document.getElementById('overlay');
        
        function toggleLeftMenu() {
            leftSidebar.classList.toggle('active');
            overlay.style.display = leftSidebar.classList.contains('active') ? 'block' : 'none';
            playSound('click');
        }
        
        function toggleRightMenu() {
            rightSidebar.classList.toggle('active');
            overlay.style.display = rightSidebar.classList.contains('active') ? 'block' : 'none';
            playSound('click');
        }
        
        leftMenuToggle.addEventListener('click', toggleLeftMenu);
        rightMenuToggle.addEventListener('click', toggleRightMenu);
        
        // Close sidebars when clicking on overlay
        overlay.addEventListener('click', () => {
            leftSidebar.classList.remove('active');
            rightSidebar.classList.remove('active');
            overlay.style.display = 'none';
        });
        
        // Close buttons inside sidebars
        document.getElementById('left-sidebar-toggle').addEventListener('click', toggleLeftMenu);
        document.getElementById('right-sidebar-toggle').addEventListener('click', toggleRightMenu);

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                const tabId = tab.dataset.tab + '-tab';
                document.getElementById(tabId).classList.add('active');
                
                playSound('click');
            });
        });

        // Settings toggles
        document.getElementById('dark-mode-toggle').addEventListener('change', (e) => {
            document.documentElement.style.setProperty('--background', e.target.checked ? '#1a1a1b' : '#f0f0f0');
            document.documentElement.style.setProperty('--surface', e.target.checked ? '#272729' : '#ffffff');
            document.documentElement.style.setProperty('--surface-dark', e.target.checked ? '#1e1e1f' : '#f5f5f5');
            document.documentElement.style.setProperty('--surface-light', e.target.checked ? '#343536' : '#e0e0e0');
            document.documentElement.style.setProperty('--text-primary', e.target.checked ? '#d7dadc' : '#333333');
            document.documentElement.style.setProperty('--text-secondary', e.target.checked ? '#818384' : '#666666');
            document.documentElement.style.setProperty('--border', e.target.checked ? '#343536' : '#e0e0e0');
            document.documentElement.style.setProperty('--grid-color', e.target.checked ? '#2c2c2c' : '#e0e0e0');
            
            saveUserData();
            playSound('click');
        });
        
        document.getElementById('grid-toggle').addEventListener('change', () => {
            canvas.needsRedraw = true;
            drawCanvas();
            saveUserData();
            playSound('click');
        });
        
        document.getElementById('hover-preview-toggle').addEventListener('change', () => {
            if (!this.checked) {
                hoverPixel.style.display = 'none';
            }
            saveUserData();
            playSound('click');
        });
        
        document.getElementById('sound-toggle').addEventListener('change', () => {
            saveUserData();
            playSound('click');
        });

        // Save image button
        document.getElementById('save-image-button').addEventListener('click', () => {
            // Create a temporary canvas to draw the current view
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Draw the current canvas (we need to ensure it's up to date)
            tempCtx.drawImage(canvas, 0, 0);
            
            // Convert to data URL and download
            const dataURL = tempCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `astro-places-${new Date().toISOString().slice(0, 10)}.png`;
            link.href = dataURL;
            link.click();
            
            showNotification('Image downloaded successfully', 'success');
            playSound('click');
            
            // Log download event
            logEvent(analytics, 'image_downloaded', {
                user_id: userId
            });
        });

        // Timelapse functionality
        const timelapseContainer = document.getElementById('timelapse-container');
        const timelapseCanvas = document.getElementById('timelapse-canvas');
        const timelapseCtx = timelapseCanvas.getContext('2d');
        let timelapseFrames = [];
        let currentTimelapseFrame = 0;
        let timelapseInterval = null;
        
        // Open timelapse modal
        document.getElementById('timelapse-button').addEventListener('click', () => {
            // Show loading state
            document.getElementById('timelapse-time').textContent = 'Loading...';
            document.getElementById('timelapse-frame').textContent = '';
            
            // Get history data
            const historyRef = query(ref(db, 'history'), orderByChild('timestamp'));
            
            get(historyRef).then((snapshot) => {
                const historyData = snapshot.val() || {};
                
                // Convert to array and sort by timestamp
                const historyArray = Object.values(historyData).sort((a, b) => a.timestamp - b.timestamp);
                
                if (historyArray.length === 0) {
                    showNotification('No history data available for timelapse', 'error');
                    return;
                }
                
                // Initialize timelapse canvas
                timelapseCanvas.width = canvasSize;
                timelapseCanvas.height = canvasSize;
                timelapseCtx.fillStyle = '#FFFFFF';
                timelapseCtx.fillRect(0, 0, canvasSize, canvasSize);
                
                // Process frames
                timelapseFrames = [];
                let currentFrame = Array(canvasSize).fill().map(() => Array(canvasSize).fill('#FFFFFF'));
                
                historyArray.forEach((item, index) => {
                    const x = item.x;
                    const y = item.y;
                    const color = item.color === 'erased' ? '#FFFFFF' : `#${item.color}`;
                    
                    // Update current frame
                    currentFrame[x][y] = color;
                    
                    // Take a snapshot every 100 changes or at the end
                    if (index % 100 === 0 || index === historyArray.length - 1) {
                        // Create a deep copy of currentFrame
                        const frameCopy = currentFrame.map(row => [...row]);
                        timelapseFrames.push({
                            frame: frameCopy,
                            timestamp: item.timestamp,
                            index: index
                        });
                    }
                });
                
                // Update UI
                document.getElementById('timelapse-slider').max = timelapseFrames.length - 1;
                document.getElementById('timelapse-slider').value = 0;
                document.getElementById('timelapse-frame').textContent = `Frame: 1/${timelapseFrames.length}`;
                document.getElementById('timelapse-time').textContent = `Time: ${formatDate(timelapseFrames[0].timestamp)}`;
                
                // Draw first frame
                drawTimelapseFrame(0);
                
                // Show modal
                timelapseContainer.style.display = 'flex';
                
                // Log timelapse view event
                logEvent(analytics, 'timelapse_viewed', {
                    user_id: userId,
                    frame_count: timelapseFrames.length
                });
            }).catch(error => {
                console.error("Error loading timelapse data:", error);
                showNotification('Error loading timelapse data', 'error');
            });
            
            playSound('click');
        });
        
        // Close timelapse modal
        document.getElementById('timelapse-close').addEventListener('click', () => {
            timelapseContainer.style.display = 'none';
            
            // Clear any playing timelapse
            if (timelapseInterval) {
                clearInterval(timelapseInterval);
                timelapseInterval = null;
            }
            
            playSound('click');
        });
        
        // Draw a specific timelapse frame
        function drawTimelapseFrame(frameIndex) {
            if (frameIndex < 0 || frameIndex >= timelapseFrames.length) return;
            
            const frame = timelapseFrames[frameIndex].frame;
            currentTimelapseFrame = frameIndex;
            
            // Clear canvas
            timelapseCtx.fillStyle = '#FFFFFF';
            timelapseCtx.fillRect(0, 0, canvasSize, canvasSize);
            
            // draw all pixels
            for (let x = 0; x < canvasSize; x++) {
                for (let y = 0; y < canvasSize; y++) {
                    if (frame[x][y] !== '#FFFFFF') {
                        timelapseCtx.fillStyle = frame[x][y];
                        timelapseCtx.fillRect(x, y, 1, 1);
                    }
                }
            }
            

            document.getElementById('timelapse-time').textContent = `Time: ${formatDate(timelapseFrames[frameIndex].timestamp)}`;
            document.getElementById('timelapse-frame').textContent = `Frame: ${frameIndex + 1}/${timelapseFrames.length}`;
            document.getElementById('timelapse-slider').value = frameIndex;
        }
        

        document.getElementById('timelapse-slider').addEventListener('input', (e) => {
            const frameIndex = parseInt(e.target.value);
            drawTimelapseFrame(frameIndex);
        });
        

        document.getElementById('timelapse-play').addEventListener('click', () => {

            document.getElementById('timelapse-play').disabled = true;
            document.getElementById('timelapse-pause').disabled = false;
            

            timelapseInterval = setInterval(() => {
                if (currentTimelapseFrame < timelapseFrames.length - 1) {
                    drawTimelapseFrame(currentTimelapseFrame + 1);
                } else {
                
                    clearInterval(timelapseInterval);
                    timelapseInterval = null;
                    document.getElementById('timelapse-play').disabled = false;
                    document.getElementById('timelapse-pause').disabled = true;
                }
            }, 100); // 10 fps
            
            playSound('click');
        });
        

        document.getElementById('timelapse-pause').addEventListener('click', () => {
            if (timelapseInterval) {
                clearInterval(timelapseInterval);
                timelapseInterval = null;
            }
            
            document.getElementById('timelapse-play').disabled = false;
            document.getElementById('timelapse-pause').disabled = true;
            
            playSound('click');
        });
        

        document.getElementById('timelapse-export').addEventListener('click', () => {
            showNotification('Exporting timelapse as GIF... (this is a demo)', 'success');
            playSound('click');
            
     
            logEvent(analytics, 'timelapse_exported', {
                user_id: userId,
                frame_count: timelapseFrames.length
            });
        });

        // Username modal handling
        document.getElementById('username-submit').addEventListener('click', () => {
            const input = document.getElementById('username-input');
            const name = input.value.trim();
            
            if (name.length < 3) {
                showNotification('Username must be at least 3 characters', 'error');
                playSound('error');
                return;
            }
            
            if (name.length > 16) {
                showNotification('Username must be 16 characters or less', 'error');
                playSound('error');
                return;
            }
            
            // Check for inappropriate usernames
            const bannedWords = ['admin', 'moderator', 'owner', 'fuck', 'shit', 'nigger', 'asshole', 'bitch'];
            if (bannedWords.some(word => name.toLowerCase().includes(word))) {
                showNotification('Username contains inappropriate content', 'error');
                playSound('error');
                return;
            }
            
            initializeUserSession(name);
            playSound('click');
        });

        // Allow Enter key to submit username
        document.getElementById('username-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('username-submit').click();
            }
        });

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', () => {
            // Clear user data
            clearUserData();
            
            // Reset user session
            userId = '';
            username = '';
            
            // Update UI
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('username-modal').style.display = 'flex';
            document.getElementById('username-input').value = '';
            document.getElementById('username-input').focus();
            
            // Remove from online users
            if (userPresenceRef) {
                remove(userPresenceRef);
                userPresenceRef = null;
            }
            
            showNotification('Logged out successfully', 'success');
            playSound('click');
            
            // Log logout event
            logEvent(analytics, 'logout', {
                user_id: userId
            });
        });

        // Initialize the application
        function init() {
            // Check for saved user data
            const savedUser = loadUserData();
            
            if (savedUser && savedUser.username) {
                // Apply saved settings
                if (savedUser.settings) {
                    document.getElementById('dark-mode-toggle').checked = savedUser.settings.darkMode;
                    document.getElementById('grid-toggle').checked = savedUser.settings.gridVisible;
                    document.getElementById('hover-preview-toggle').checked = savedUser.settings.hoverPreview;
                    document.getElementById('sound-toggle').checked = savedUser.settings.soundEnabled;
                    
                    // Trigger change events to apply settings
                    document.getElementById('dark-mode-toggle').dispatchEvent(new Event('change'));
                    document.getElementById('grid-toggle').dispatchEvent(new Event('change'));
                }
                
                initializeUserSession(savedUser.username, savedUser.userId);
            } else {
                // Show username modal
                document.getElementById('username-modal').style.display = 'flex';
                document.getElementById('username-input').focus();
            }
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Zoom with + and - keys
                if (e.key === '+' || e.key === '=') {
                    document.getElementById('zoom-in').click();
                } else if (e.key === '-' || e.key === '_') {
                    document.getElementById('zoom-out').click();
                }
                
                // Quick color selection with number keys (1-9 for first 9 colors)
                if (e.key >= '1' && e.key <= '9') {
                    const index = parseInt(e.key) - 1;
                    if (index < colors.length) {
                        const colorOption = document.querySelectorAll('.color-option')[index];
                        if (colorOption) {
                            colorOption.click();
                        }
                    }
                }
                
                // Quick eraser with E key
                if (e.key.toLowerCase() === 'e') {
                    document.getElementById('eraser-toggle').click();
                }
                
                // Place pixel with spacebar when hovering
                if (e.key === ' ' && currentHoverX >= 0 && currentHoverY >= 0) {
                    placePixel(currentHoverX, currentHoverY);
                }
            });
            
            // Log app initialized event
            logEvent(analytics, 'app_initialized');
        }

        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
