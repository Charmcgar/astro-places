<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro Places</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            background-color: #1a1a1b;
            color: #d7dadc;
            height: 100vh;
            overflow: hidden;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
            overflow-y: auto;
        }
        .sidebar {
            width: 300px;
            padding: 1rem;
            background-color: #1a1a1b;
            border-left: 1px solid #343536;
            overflow-y: auto;
            height: 100vh;
        }
        .left-sidebar {
            border-left: none;
            border-right: 1px solid #343536;
        }
        .header {
            width: 100%;
            background-color: #1a1a1b;
            color: white;
            text-align: center;
            padding: 1rem 0;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-icon {
            color: #ff4500;
            font-size: 24px;
            font-weight: bold;
        }
        .logo-text {
            font-size: 22px;
            font-weight: bold;
            color: #ff4500;
        }
        #canvas-container {
            position: relative;
            margin-bottom: 1rem;
            border: 1px solid #343536;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            overflow: hidden;
            background-image: linear-gradient(45deg, #2c2c2c 25%, transparent 25%), 
                              linear-gradient(-45deg, #2c2c2c 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #2c2c2c 75%), 
                              linear-gradient(-45deg, transparent 75%, #2c2c2c 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        #place-canvas {
            background-color: transparent;
            image-rendering: pixelated;
            cursor: crosshair;
        }
        .hover-pixel {
            position: absolute;
            pointer-events: none;
            border: 1px solid white;
            box-shadow: 0 0 0 1px black;
            display: none;
        }
        .color-picker {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 1rem 0;
            max-width: 400px;
            background-color: #272729;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .color-option {
            width: 30px;
            height: 30px;
            margin: 4px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid #272729;
            transition: transform 0.1s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border: 2px solid white;
            transform: scale(1.1);
            box-shadow: 0 0 5px rgba(255,255,255,0.5);
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
            gap: 10px;
            width: 100%;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 5px 0;
            width: 100%;
            justify-content: center;
        }
        #zoom-controls {
            display: flex;
            gap: 10px;
        }
        button {
            background-color: #ff4500;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #ff5722;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #cooldown {
            font-weight: bold;
            color: #ff4500;
            margin-top: 0.5rem;
            padding: 8px 12px;
            border-radius: 24px;
            background-color: #272729;
        }
        .cooldown-active {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .timer-circle {
            position: relative;
            width: 24px;
            height: 24px;
        }
        .timer-circle svg {
            transform: rotate(-90deg);
        }
        .timer-circle circle {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
        }
        .timer-bg {
            stroke: #444;
        }
        .timer-progress {
            stroke: #ff4500;
            transition: stroke-dashoffset 1s linear;
        }
        .stats-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin-top: 1rem;
            padding: 10px;
            background-color: #272729;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 10px;
        }
        .stat-label {
            font-size: 12px;
            color: #818384;
        }
        .stat-value {
            font-size: 16px;
            font-weight: bold;
        }
        #coordinates {
            padding: 8px 12px;
            font-family: monospace;
            background-color: #272729;
            border-radius: 4px;
            display: inline-block;
        }
        .history-viewer {
            width: 100%;
            margin-top: 1rem;
            padding: 15px;
            background-color: #272729;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .history-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #e8e6e3;
        }
        .history-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px;
            background-color: #3a3a3c;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
        }
        .history-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            display: inline-block;
        }
        .leaderboard {
            width: 100%;
            margin-top: 1rem;
            padding: 15px;
            background-color: #272729;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .leaderboard-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #e8e6e3;
        }
        .leaderboard-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #3a3a3c;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.4;
        }
        .leaderboard-user {
            font-weight: bold;
        }
        .leaderboard-count {
            color: #ff4500;
            font-weight: bold;
        }
        .leaderboard-position {
            width: 24px;
            text-align: center;
            font-weight: bold;
            color: #ff4500;
            margin-right: 8px;
        }
        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            font-weight: bold;
            border-bottom: 1px solid #343536;
            margin-bottom: 5px;
        }
        .username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .username-box {
            background-color: #272729;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            width: 300px;
            text-align: center;
        }
        .username-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #ff4500;
        }
        .username-input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            background-color: #343536;
            border: 1px solid #515252;
            color: #d7dadc;
            border-radius: 4px;
            font-size: 1rem;
        }
        .username-submit {
            width: 100%;
            padding: 0.75rem;
            background-color: #ff4500;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .username-submit:hover {
            background-color: #ff5722;
        }
        .discord-widget {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
            padding: 10px;
            background-color: #272729;
            border-radius: 8px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ff4500;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        .user-name {
            font-weight: bold;
        }
        .logout-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: #818384;
            cursor: pointer;
            font-size: 12px;
        }
        .logout-btn:hover {
            color: #d7dadc;
        }
        @media (max-width: 1200px) {
            .sidebar {
                width: 250px;
            }
        }
        @media (max-width: 992px) {
            body {
                flex-direction: column;
                overflow-y: auto;
                height: auto;
            }
            .sidebar {
                width: 100%;
                height: auto;
                border-left: none;
                border-right: none;
                border-top: 1px solid #343536;
                order: 2;
            }
            .main-content {
                order: 1;
            }
        }
        @media (max-width: 768px) {
            .color-picker {
                max-width: 320px;
            }
            .stats-container {
                flex-wrap: wrap;
            }
            .stat-item {
                width: 50%;
                margin-bottom: 10px;
            }
        }
        #notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #272729;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none;
            z-index: 100;
            animation: slideIn 0.3s ease-out;
        }
        .banned-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.2em;
            z-index: 1000;
        }
        .banned-mode .color-picker,
        .banned-mode #zoom-controls,
        .banned-mode canvas {
            opacity: 0.5;
            pointer-events: none;
        }
        @keyframes slideIn {
            0% { transform: translateY(100px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="sidebar left-sidebar">
        <div class="user-info" id="user-info" style="display: none;">
            <div class="user-avatar" id="user-avatar">A</div>
            <div class="user-name" id="username-display">Anonymous</div>
            <button class="logout-btn" id="logout-btn">Logout</button>
        </div>
        <div class="leaderboard">
            <div class="leaderboard-title">Top Contributors</div>
            <div class="leaderboard-container" id="leaderboard-container"></div>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">Astro</div>
                <div class="logo-text">Places</div>
            </div>
        </div>
        
        <div class="container">
            <div class="control-group">
                <div id="cooldown">Ready to place a pixel!</div>
                <div id="coordinates">Hover over canvas to see coordinates</div>
            </div>
            
            <div id="canvas-container">
                <canvas id="place-canvas" width="100" height="100"></canvas>
                <div class="hover-pixel" id="hover-pixel"></div>
            </div>
            
            <div class="color-picker" id="color-picker"></div>
            
            <div class="controls">
                <div class="control-group">
                    <div id="zoom-controls">
                        <button id="zoom-out">-</button>
                        <button id="zoom-reset">Reset View</button>
                        <button id="zoom-in">+</button>
                    </div>
                    <button id="timelapse-button">View Timelapse</button>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-item">
                    <div class="stat-value" id="user-count">0</div>
                    <div class="stat-label">Users Online</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pixel-count">0</div>
                    <div class="stat-label">Pixels Placed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="your-pixels">0</div>
                    <div class="stat-label">Your Pixels</div>
                </div>
            </div>
            
            <div class="history-viewer">
                <div class="history-title">Recent Activity</div>
                <div class="history-container" id="history-container"></div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="discord-widget">

        </div>
    </div>
    
    <div id="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCpOUr78CAyGatrQdVOw6yf8EK4OvtoMoo",
            authDomain: "astro-places-1aec2.firebaseapp.com",
            projectId: "astro-places-1aec2",
            storageBucket: "astro-places-1aec2.appspot.com",
            messagingSenderId: "502500788903",
            appId: "1:502500788903:web:5f742fd1ad5cce9063e982",
            measurementId: "G-6J7SM1KM05",
            databaseURL: "https://astro-places-1aec2-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Canvas setup
        const canvas = document.getElementById('place-canvas');
        const ctx = canvas.getContext('2d');
        let canvasSize = 100;
        const pixelSize = 3;
        
        // Current view properties
        let zoom = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        // User interaction
        let selectedColor = '#000000';
        let lastPlacedTime = 0;
        const cooldownTime = 0; 
        let userId = '';
        let username = 'Anonymous';
        let userPresenceRef = null;
        let myPixelCount = 0;
        let totalPixelCount = 0;
        
        // Hover preview
        const hoverPixel = document.getElementById('hover-pixel');
        
        // Color palette
        const colors = [
            '#FFFFFF', '#D4D7D9', '#898D90', '#515252', '#000000',
            '#D80000', '#FF4500', '#FFA800', '#FFD635', '#00A368',
            '#7EED56', '#2450A4', '#3690EA', '#51E9F4', '#811E9F',
            '#B44AC0', '#FF99AA', '#6A5CFF', '#E4ABFF', '#BE0039',
            '#FF3881', '#493AC1', '#6D001A', '#6D482F', '#9C6926',
            '#008080', '#00CED1', '#20B2AA', '#556B2F', '#8FBC8F',
            '#F08080', '#FA8072', '#FFDAB9', '#FFB6C1', '#DB7093',
            '#9370DB', '#BA55D3', '#8A2BE2', '#4B0082', '#4169E1',
            '#00BFFF', '#1E90FF', '#7B68EE', '#FF6347', '#FF7F50',
            '#FFA07A', '#EEE8AA', '#98FB98', '#ADFF2F'
        ];

        // Track user pixel counts for leaderboard
        const userPixelCounts = {};
        const usernames = {};

        // Create color picker
        const colorPicker = document.getElementById('color-picker');
        colors.forEach(color => {
            const colorOption = document.createElement('div');
            colorOption.className = 'color-option';
            colorOption.style.backgroundColor = color;
            colorOption.addEventListener('click', () => {
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                colorOption.classList.add('selected');
                selectedColor = color;
                
                if (hoverPixel.style.display === 'block') {
                    hoverPixel.style.backgroundColor = color;
                }
            });
            colorPicker.appendChild(colorOption);
        });
        
        // Select the first color by default
        document.querySelector('.color-option').classList.add('selected');

        // Resize canvas element based on zoom level
        function resizeCanvas() {
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            canvas.style.width = (canvasSize * pixelSize * zoom) + 'px';
            canvas.style.height = (canvasSize * pixelSize * zoom) + 'px';
            document.getElementById('canvas-container').style.width = (canvasSize * pixelSize * zoom) + 'px';
            document.getElementById('canvas-container').style.height = (canvasSize * pixelSize * zoom) + 'px';
            
            hoverPixel.style.width = (pixelSize * zoom) + 'px';
            hoverPixel.style.height = (pixelSize * zoom) + 'px';
            
            canvas.needsRedraw = true;
            drawCanvas();
        }

        // Draw canvas with buffering
        function drawCanvas() {
            if (!canvas.needsRedraw) return;
            canvas.needsRedraw = false;
            
            if (!canvas.buffer) {
                canvas.buffer = document.createElement('canvas');
                canvas.buffer.width = canvas.width;
                canvas.buffer.height = canvas.height;
                canvas.bufferCtx = canvas.buffer.getContext('2d');
                canvas.backgroundDrawn = false;
            }
            
            if (!canvas.backgroundDrawn) {
                canvas.bufferCtx.fillStyle = '#FFFFFF';
                canvas.bufferCtx.fillRect(0, 0, canvas.width, canvas.height);
                canvas.backgroundDrawn = true;
            }
            
            const pixelsRef = db.ref('pixels');
            pixelsRef.on('value', (snapshot) => {
                const pixelData = snapshot.val() || {};
                
                requestAnimationFrame(() => {
                    canvas.bufferCtx.clearRect(0, 0, canvas.width, canvas.height);
                    canvas.bufferCtx.fillStyle = '#FFFFFF';
                    canvas.bufferCtx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    totalPixelCount = 0;
                    myPixelCount = 0;
                    
                    for (const userId in userPixelCounts) {
                        userPixelCounts[userId] = 0;
                    }
                    
                    for (const key in pixelData) {
                        const [x, y] = key.split(',');
                        const xInt = parseInt(x);
                        const yInt = parseInt(y);
                        
                        if (xInt >= 0 && xInt < canvasSize && yInt >= 0 && yInt < canvasSize) {
                            const pixelValue = pixelData[key];
                            let pixelColor;
                            
                            if (typeof pixelValue === 'string') {
                                pixelColor = pixelValue.startsWith('#') ? pixelValue : `#${pixelValue}`;
                            } else if (pixelValue?.color) {
                                pixelColor = pixelValue.color.startsWith('#') ? pixelValue.color : `#${pixelValue.color}`;
                            } else {
                                pixelColor = '#FFFFFF';
                            }
                            
                            canvas.bufferCtx.fillStyle = pixelColor;
                            canvas.bufferCtx.fillRect(xInt, yInt, 1, 1);
                            totalPixelCount++;
                            
                            if (typeof pixelValue === 'object' && pixelValue?.userId) {
                                const userId = pixelValue.userId;
                                userPixelCounts[userId] = (userPixelCounts[userId] || 0) + 1;
                                
                                if (userId === userId) {
                                    myPixelCount++;
                                }
                            }
                        }
                    }
                    
                    ctx.drawImage(canvas.buffer, 0, 0);
                    document.getElementById('pixel-count').textContent = totalPixelCount;
                    document.getElementById('your-pixels').textContent = myPixelCount;
                    updateLeaderboard();
                });
            });
        }

        // Place pixel with ban check
        async function placePixel(x, y) {
            const user = auth.currentUser;
            if (!user) return;

            // Check ban status
            const banRef = db.ref(`bans/${user.uid}`);
            const banSnapshot = await banRef.once('value');
            
            if (banSnapshot.exists()) {
                showNotification('⛔ You are banned from placing pixels');
                return;
            }

            const now = Date.now();
            if (now - lastPlacedTime < cooldownTime) {
                showNotification('Please wait for the cooldown to expire');
                return;
            }

            if (x < 0 || x >= canvasSize || y < 0 || y >= canvasSize) {
                return;
            }

            const pixelRef = db.ref(`pixels/${x},${y}`);

            if (selectedColor === '#FFFFFF') {
                try {
                    await pixelRef.remove();
                    lastPlacedTime = now;
                    updateCooldown();
                    addToHistory(x, y, 'erased');
                    showNotification('Pixel erased successfully!');
                } catch (error) {
                    console.error("Error erasing pixel: ", error);
                    showNotification('Error erasing pixel. Try again.');
                }
            } else {
                try {
                    await pixelRef.set({
                        color: selectedColor,
                        userId: user.uid,
                        username: username,
                        timestamp: Date.now()
                    });
                    lastPlacedTime = now;
                    updateCooldown();
                    addToHistory(x, y, selectedColor);
                    showNotification('Pixel placed successfully!');
                } catch (error) {
                    console.error("Error placing pixel: ", error);
                    showNotification('Error placing pixel. Try again.');
                }
            }
            
            canvas.needsRedraw = true;
        }

        // Update cooldown timer
        function updateCooldown() {
            const cooldownElement = document.getElementById('cooldown');
            const now = Date.now();
            
            if (now - lastPlacedTime < cooldownTime) {
                const remainingTime = Math.ceil((cooldownTime - (now - lastPlacedTime)) / 1000);
                const percentage = ((cooldownTime - (now - lastPlacedTime)) / cooldownTime) * 100;
                
                if (!document.querySelector('.timer-circle')) {
                    cooldownElement.innerHTML = '';
                    cooldownElement.classList.add('cooldown-active');
                    
                    const timerCircle = document.createElement('div');
                    timerCircle.className = 'timer-circle';
                    timerCircle.innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <circle class="timer-bg" cx="12" cy="12" r="10" />
                            <circle class="timer-progress" cx="12" cy="12" r="10" stroke-dasharray="62.8" stroke-dashoffset="0" />
                        </svg>
                    `;
                    
                    const timerText = document.createElement('span');
                    timerText.className = 'timer-text';
                    timerText.textContent = `${remainingTime}s`;
                    
                    cooldownElement.appendChild(timerCircle);
                    cooldownElement.appendChild(timerText);
                }
                
                const progressCircle = document.querySelector('.timer-progress');
                const timerText = document.querySelector('.timer-text');
                
                const circumference = 2 * Math.PI * 10;
                const offset = circumference - (percentage / 100) * circumference;
                progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
                progressCircle.style.strokeDashoffset = offset;
                
                timerText.textContent = `${remainingTime}s`;
                
                setTimeout(updateCooldown, 50);
            } else {
                cooldownElement.classList.remove('cooldown-active');
                cooldownElement.innerHTML = 'Ready to place a pixel!';
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Add to history log
        function addToHistory(x, y, color) {
            const historyRef = db.ref('history');
            historyRef.push({
                x: x,
                y: y,
                color: color,
                userId: auth.currentUser?.uid,
                username: username,
                timestamp: Date.now()
            });
        }

        // Update leaderboard
        function updateLeaderboard() {
            const leaderboardContainer = document.getElementById('leaderboard-container');
            
            const sortedUsers = Object.entries(userPixelCounts)
                .map(([userId, count]) => ({ 
                    userId, 
                    count,
                    username: usernames[userId] || userId.substring(0, 8)
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
            
            const fragment = document.createDocumentFragment();
            
            const header = document.createElement('div');
            header.className = 'leaderboard-header';
            header.innerHTML = `
                <span>User</span>
                <span>Pixels</span>
            `;
            fragment.appendChild(header);
            
            sortedUsers.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div style="display: flex; flex-direction: column;">
                        <div style="display: flex; align-items: center;">
                            <span class="leaderboard-position">${index + 1}</span>
                            <span class="leaderboard-user">${user.username}</span>
                        </div>
                        <small style="color: #818384; font-size: 0.8em;">ID: ${user.userId}</small>
                    </div>
                    <span class="leaderboard-count">${user.count}</span>
                `;
                fragment.appendChild(item);
            });
            
            leaderboardContainer.innerHTML = '';
            leaderboardContainer.appendChild(fragment);
        }

        // User presence handling
        function setupUserPresence() {
            const user = auth.currentUser;
            if (!user) return;

            userPresenceRef = db.ref(`users/${user.uid}`);
            
            userPresenceRef.set({
                online: true,
                username: username,
                lastActive: Date.now()
            });
            
            setInterval(() => {
                userPresenceRef.update({
                    lastActive: Date.now()
                });
            }, 30000);
            
            const usersRef = db.ref('users');
            let lastUserCountUpdate = 0;
            
            usersRef.on('value', (snapshot) => {
                const now = Date.now();
                if (now - lastUserCountUpdate < 5000) return;
                lastUserCountUpdate = now;
                
                const users = snapshot.val() || {};
                const activeUsers = Object.values(users).filter(user => 
                    user.online && (now - user.lastActive < 60000)
                ).length;
                
                document.getElementById('user-count').textContent = activeUsers;
                
                for (const userId in users) {
                    if (users[userId].username) {
                        usernames[userId] = users[userId].username;
                    }
                }
            });
        }

        // Initialize user session with auth
        async function initializeUserSession() {
            try {
                // Sign in anonymously
                const userCredential = await auth.signInAnonymously();
                const user = userCredential.user;
                userId = user.uid;
                
                // Check ban status
                const banRef = db.ref(`bans/${user.uid}`);
                const banSnapshot = await banRef.once('value');
                
                if (banSnapshot.exists()) {
                    document.body.classList.add('banned-mode');
                    document.body.innerHTML += `
                        <div class="banned-message">
                            ⛔ Your account has been banned
                        </div>
                    `;
                    return;
                }
                
                // Not banned - proceed
                document.getElementById('user-info').style.display = 'flex';
                document.getElementById('username-modal').style.display = 'none';
                
                setupUserPresence();
                
                const configRef = db.ref('config/canvasSize');
                configRef.once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        canvasSize = snapshot.val();
                    }
                    resizeCanvas();
                    drawCanvas();
                });
                
            } catch (error) {
                console.error("Authentication error:", error);
            }
        }

        // Canvas interaction events
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            
            placePixel(x, y);
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            
            document.getElementById('coordinates').textContent = `(${x}, ${y})`;
            
            if (x >= 0 && x < canvasSize && y >= 0 && y < canvasSize) {
                hoverPixel.style.display = 'block';
                hoverPixel.style.left = (x * pixelSize * zoom) + 'px';
                hoverPixel.style.top = (y * pixelSize * zoom) + 'px';
                hoverPixel.style.backgroundColor = selectedColor;
            } else {
                hoverPixel.style.display = 'none';
            }
        });
        
        canvas.addEventListener('mouseout', () => {
            hoverPixel.style.display = 'none';
        });

        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', () => {
            zoom = Math.min(zoom + 0.5, 5);
            resizeCanvas();
        });
        
        document.getElementById('zoom-out').addEventListener('click', () => {
            zoom = Math.max(zoom - 0.5, 0.5);
            resizeCanvas();
        });
        
        document.getElementById('zoom-reset').addEventListener('click', () => {
            zoom = 1;
            resizeCanvas();
        });

        // Panning/dragging
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            canvas.style.cursor = 'grabbing';
        });
        
        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const dx = e.clientX - lastMouseX;
            const dy = e.clientY - lastMouseY;
            
            offsetX += dx;
            offsetY += dy;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            canvas.needsRedraw = true;
        });
        
        window.addEventListener('mouseup', () => {
            isDragging = false;
            canvas.style.cursor = 'crosshair';
        });

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                location.reload();
            });
        });

        // Initialize the application
        function init() {
            initializeUserSession();
        }

        // Start the app
        init();
    </script>
</body>
</html>
